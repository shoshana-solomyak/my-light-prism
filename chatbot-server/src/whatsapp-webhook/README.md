# WhatsApp Integration

This project uses _Meta Cloud API_ for sending messages via WhatsApp.

- Read [_Meta_'s docs](https://developers.facebook.com/docs/WhatsApp/cloud-api/) for
  detailed explanations, Getting Started tutorial and API Reference.
- Read this document for short overview of the API integration in _Hilma_ projects.

## Meta Developer Account

To use _Meta Cloud API_ for messaging, a project needs to have a _Business App_ app
with _Meta_.

In order to access your project's app, you need to be added to _Hilma_'s _Business
Account_. You should ask one of the account admins to send you an invitation to the
business.

> [!NOTE]  
> Currently, the administrators of _Hilma_'s _Business Account_ are:
>
> - Doron Nissimi
> - Hemda Imber

Once you are a member of the business, you can log into
[_Meta Developer Account_](https://developers.facebook.com/?no_redirect=1) and see
your apps there.

> [!IMPORTANT]  
> Unfortunately, it is _not_ possible to create new Facebook accounts dedicated to
> development. You have to use your own personal (non work related) Facebook Account.

If you are the first developer to work on your project, then you need to
[create a new app](https://developers.facebook.com/docs/development/create-an-app/).
Make sure to add _Hilma_ as the app's business portfolio.

## WhatsApp API Setup: Development

In order to develop and test WhatsApp messaging, you need to be able to connect your
`localhost` dev server, and your personal phone number to the API.

### Setup Phone Numbers

1. Go to https://developers.facebook.com/apps/ and choose your app
2. In the dashboard menu, go to _Products_ => _WhatsApp_ => _API Setup_. If WhatsApp
   is not in the list, click _Add Product_ to add it.
3. At the top of the page, generate an access token and add it to `.env.development`
   file. The token is required for sending messages. Note: **This is a temporary
   token**.

> [!WARNING]  
> Do not push any of the secrets you added to the `.env` file for debugging to
> Github! They are secretive!

4. Choose _Test Number_ as the sender number, and add your own phone number as the
   recipient.

### Setup Webhook

In order to listen to WhatsApp messages and notifications in our app, the server
exposes to _Meta_ an endpoint with 2 methods:

- `GET` - Verification endpoint that ensures a connection was established
  successfully
- `POST` - Endpoint for receiving new notifications and responding to them.

1. In the WhatsApp API Setup page, click on _Configure Webhooks_.
2. Add `Callback URL`: the server endpoint. See
   [[#Expose Development Endpoint With `ngrok`]] for creating development endpoint
   URL.
3. Add `Verify token`: a token generated by us, and used in our code to verify the
   request. This string should exist in your `.env.development` as well.
4. Choose to which events to listen.
5. Click _Verify and save_.

### Add App Secret to `.env.development`

_Meta_ signs all its `POST` requests with a `x-hub-signature-256` header, using your
_App Secret_. In order to validate the signature, You have to add the _App Secret_ to
your `.env.development`. The _App Secret_ can be found in the App Dashboard under
_App Setting_ => _Basic_.

### Expose Development Endpoint With `ngrok`

You need to expose your `localhost` endpoint in order to test the webhooks locally.
`ngrok` is a useful tool for achieving that goal.

1. Go to https://ngrok.com/ and create an account.
2. Follow `ngrok` Connect instructions to Install `ngrok` on your computer.
3. Run your local server, and then execute this command to expose it:
    ```shell
    ngrok http http://localhost:8080
    ```
4. Your server is now available in the URL showed on screen. Paste the URL + webhook
   endpoint in the `Callback URL` field of _Meta_'s webhook configuration.

## App Deployment

> [!TODO]  
> Write when we deploy. There is a todo list
> [here](https://docs.google.com/document/d/1d-BpIx9dG4WFqmqwnUYCQ4shKQWg3ZX1L0j6tQt2dEE/edit?tab=t.j5gqbiveowf4#heading=h.ygsvxq50m6uu).
